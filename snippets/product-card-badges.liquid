{%- doc -%}
  Renders product badges for the product card.
  Checks collection badges first, then falls back to product badges.

  @param {object} product - The product object.
  @param {object} settings - The theme settings object.
  @param {object} closest.collection - The collection object (optional).

  @example
  {% render 'product-card-badges', product: product, settings: settings, closest.collection: collection %}
{%- enddoc -%}

<div
  class="product-badges product-badges--{{ settings.badge_position }}"
  style="
    --badge-border-radius: {{ settings.badge_corner_radius }}px;
    --badge-font-family: var(--font-{{ settings.badge_font_family }}--family); --badge-font-weight: var(--font-{{ settings.badge_font_family }}--weight); --badge-text-transform: {{ settings.badge_text_transform }};
  "
>
  {%- comment -%} Default sale/sold out badges {%- endcomment -%}
  {%- if product.available == false or product.compare_at_price > product.price and product.available -%}
    <div
      class="
        product-badges__badge product-badges__badge--rectangle
        {% if product.available == false %} color-{{ settings.badge_sold_out_color_scheme }}{% elsif product.compare_at_price > product.price %} color-{{ settings.badge_sale_color_scheme }}{% endif %}
      "
    >
      {%- if product.available == false -%}
        {{ 'content.product_badge_sold_out' | t }}
      {%- elsif product.compare_at_price > product.price -%}
        {{ 'content.product_badge_sale' | t }}
      {%- endif -%}
    </div>
  {%- endif -%}

  {%- comment -%} Custom meta field badges - Collection badges take priority over product badges {%- endcomment -%}
  {%- assign badge_content = blank -%}
  
  {%- comment -%} Check for collection badges first {%- endcomment -%}
  {%- if closest.collection and closest.collection.metafields.custom.collection_badges_simple != blank -%}
    {%- assign badge_content = closest.collection.metafields.custom.collection_badges_simple -%}
  {%- comment -%} Fall back to product badges if no collection badges {%- endcomment -%}
  {%- elsif product.metafields.custom.product_badges_simple != blank -%}
    {%- assign badge_content = product.metafields.custom.product_badges_simple -%}
  {%- endif -%}
  
  {%- if badge_content != blank -%}
    {%- assign badge_lines = badge_content | split: '
' -%}
    {%- assign badge_count = 0 -%}
    {%- for badge_line in badge_lines -%}
      {%- if badge_count >= 2 -%}
        {%- break -%}
      {%- endif -%}
      {%- assign badge_line = badge_line | strip -%}
      {%- if badge_line != blank -%}
        {%- assign badge_parts = badge_line | split: '|' -%}
        {%- assign badge_text = badge_parts[0] | strip -%}
        {%- assign badge_bg = badge_parts[1] | strip -%}
        {%- assign badge_text_color = badge_parts[2] | strip -%}
        {%- if badge_text != blank -%}
          {%- assign badge_count = badge_count | plus: 1 -%}
          <div
            class="product-badges__badge product-badges__badge--rectangle product-badges__badge--custom product-badges__badge--{{ badge_count }}"
            style="
              {%- if badge_bg != blank -%}
                background-color: {{ badge_bg }};
              {%- endif -%}
              {%- if badge_text_color != blank -%}
                color: {{ badge_text_color }};
              {%- endif -%}
            "
          >
            {{ badge_text }}
          </div>
        {%- endif -%}
      {%- endif -%}
    {%- endfor -%}
  {%- endif -%}
</div>

{% stylesheet %}
  .product-badges {
    --badge-inset: max(var(--padding-xs), calc((var(--border-radius) + var(--padding-xs)) * (1 - cos(45deg))));

    position: absolute;
    z-index: var(--layer-flat);
    display: flex;
    flex-direction: column;
    gap: 4px;
  }

  .product-badges--bottom-left {
    bottom: calc(var(--badge-inset) + var(--padding-block-start));
    left: calc(var(--badge-inset) + var(--padding-inline-start));
  }

  .product-badges--top-left {
    top: calc(var(--badge-inset) + var(--padding-block-start));
    left: calc(var(--badge-inset) + var(--padding-inline-start));
  }

  .product-badges--top-right {
    top: calc(var(--badge-inset) + var(--padding-block-start));
    right: calc(var(--badge-inset) + var(--padding-inline-start));
  }

  .product-badges__badge {
    --badge-font-size: var(--font-size--xs);

    display: flex;
    align-items: center;
    justify-content: center;
    text-align: center;
    color: var(--color-foreground);
    background: var(--color-background);
    font-size: var(--badge-font-size);
    font-family: var(--badge-font-family);
    font-weight: var(--badge-font-weight);
    text-transform: var(--badge-text-transform);
    border-radius: var(--badge-border-radius);
  }

  .product-badges__badge--rectangle {
    padding-block: var(--badge-rectangle-padding-block);
    padding-inline: var(--badge-rectangle-padding-inline);
  }

  .product-badges__badge--custom {
    min-width: fit-content;
    max-width: 120px;
    word-wrap: break-word;
    white-space: normal;
    text-align: center;
  }

  /* Left and right badge positioning */
  .product-badges__badge--1 {
    position: absolute;
    left: calc(var(--badge-inset) + var(--padding-inline-start));
  }

  .product-badges__badge--2 {
    position: absolute;
    right: calc(var(--badge-inset) + var(--padding-inline-start));
  }

  /* Adjust positioning based on badge position setting */
  .product-badges--top-left .product-badges__badge--1,
  .product-badges--bottom-left .product-badges__badge--1 {
    left: calc(var(--badge-inset) + var(--padding-inline-start));
  }

  .product-badges--top-left .product-badges__badge--2,
  .product-badges--bottom-left .product-badges__badge--2 {
    right: calc(var(--badge-inset) + var(--padding-inline-start));
  }

  .product-badges--top-right .product-badges__badge--1,
  .product-badges--bottom-right .product-badges__badge--1 {
    left: calc(var(--badge-inset) + var(--padding-inline-start));
  }

  .product-badges--top-right .product-badges__badge--2,
  .product-badges--bottom-right .product-badges__badge--2 {
    right: calc(var(--badge-inset) + var(--padding-inline-start));
  }

  @media screen and (max-width: 749px) {
    .product-badges__badge--custom {
      max-width: 100px;
      font-size: calc(var(--badge-font-size) * 0.9);
    }
  }
{% endstylesheet %}
