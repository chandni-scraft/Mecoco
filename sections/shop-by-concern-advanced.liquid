{% comment %}
  Shop by Concern Advanced
  - No section blocks; uses theme block `_product-card` via content_for
  - Tabs from up to 6 settings-based collections
  - Mobile tabs scrollable; grid uses theme product card layout
{% endcomment %}

{% liquid
  assign sid = section.id
  assign heading = section.settings.heading
  assign container = section.settings.container
  assign per_tab = section.settings.products_per_tab
  assign cols_mobile = section.settings.products_per_row_mobile
  assign cols_desktop = section.settings.products_per_row_desktop
%}

<div id="shop-by-concern-adv-{{ sid }}" class="shop-by-concern-adv">
  <div class="shop-by-concern-adv__container container container--{{ container }}">
    {% if heading %}
      <h2 class="shop-by-concern-adv__heading">{{ heading }}</h2>
    {% endif %}

    {% assign has_any = false %}
    {% for i in (1..6) %}
      {% assign c = section.settings["collection_" | append: i] %}
      {% if c %}{% assign has_any = true %}{% break %}{% endif %}
    {% endfor %}

    {% if has_any %}
      <div class="shop-by-concern-adv__tabs" role="tablist" aria-label="Collections tabs">
        <div class="shop-by-concern-adv__tabs-scroll">
          {% # theme-check-disable UnknownObject %}
          {% for i in (1..6) %}
            {% assign c = section.settings["collection_" | append: i] %}
            {% assign label = section.settings["label_" | append: i] %}
            {% if c %}
            <button
              id="adv-tab-{{ sid }}-{{ i }}"
              class="shop-by-concern-adv__tab{% if forloop.index == 1 %} is-active{% endif %}"
              role="tab"
              aria-selected="{% if forloop.index == 1 %}true{% else %}false{% endif %}"
              aria-controls="adv-panel-{{ sid }}-{{ i }}"
              tabindex="{% if forloop.index == 1 %}0{% else %}-1{% endif %}"
              data-tab-index="{{ forloop.index0 }}"
            >
              {{ label | default: c.title | escape }}
            </button>
            {% endif %}
          {% endfor %}
          {% # theme-check-enable UnknownObject %}
        </div>
      </div>

      <div class="shop-by-concern-adv__panels">
        {% # theme-check-disable UnknownObject %}
        {% for i in (1..6) %}
          {% assign c = section.settings["collection_" | append: i] %}
          {% if c %}
          <div
            id="adv-panel-{{ sid }}-{{ i }}"
            class="shop-by-concern-adv__panel{% if forloop.index == 1 %} is-active{% endif %}"
            role="tabpanel"
            aria-labelledby="adv-tab-{{ sid }}-{{ i }}"
            {% unless forloop.index == 1 %}hidden{% endunless %}
          >
            <ul class="shop-by-concern-adv__grid" role="list">
              {% for product in c.products limit: per_tab %}
                <li class="shop-by-concern-adv__item">
                  {% # theme-check-disable %}
                  {% content_for 'block', type: '_product-card', id: 'product-card', closest.product: product, collection: c %}
                  {% # theme-check-enable %}
                </li>
              {% endfor %}
            </ul>
          </div>
          {% endif %}
        {% endfor %}
        {% # theme-check-enable UnknownObject %}
      </div>
    {% endif %}
  </div>
</div>

<script>
  (function(){
    var root = document.getElementById('shop-by-concern-adv-{{ sid }}');
    if (!root) return;
    var tabs = Array.prototype.slice.call(root.querySelectorAll('.shop-by-concern-adv__tab'));
    var panels = Array.prototype.slice.call(root.querySelectorAll('.shop-by-concern-adv__panel'));
    function activate(tab){
      var target = tab.getAttribute('aria-controls');
      tabs.forEach(function(t){
        var sel = t === tab; t.classList.toggle('is-active', sel);
        t.setAttribute('aria-selected', sel ? 'true' : 'false');
        t.setAttribute('tabindex', sel ? '0' : '-1');
      });
      panels.forEach(function(p){
        var on = p.id === target; p.classList.toggle('is-active', on);
        if (on) { p.removeAttribute('hidden'); } else { p.setAttribute('hidden',''); }
      });
    }
    tabs.forEach(function(t){
      t.addEventListener('click', function(){ activate(t); });
      t.addEventListener('keydown', function(e){
        var i = tabs.indexOf(t);
        if (e.key === 'ArrowRight') { e.preventDefault(); var n = tabs[(i+1)%tabs.length]; n.focus(); activate(n); }
        if (e.key === 'ArrowLeft') { e.preventDefault(); var p = tabs[(i-1+tabs.length)%tabs.length]; p.focus(); activate(p); }
      });
    });
  })();
</script>

<style>
  #shop-by-concern-adv-{{ sid }} .shop-by-concern-adv__heading{margin:0 0 1rem;text-align:center}
  #shop-by-concern-adv-{{ sid }} .shop-by-concern-adv__tabs{overflow:hidden;margin-bottom:1rem}
  #shop-by-concern-adv-{{ sid }} .shop-by-concern-adv__tabs-scroll{display:flex;gap:.5rem;overflow-x:auto;-webkit-overflow-scrolling:touch;scrollbar-width:thin}
  #shop-by-concern-adv-{{ sid }} .shop-by-concern-adv__tab{white-space:nowrap;padding:.6rem 1rem;border:1px solid rgba(0,0,0,.12);border-radius:999px;background:var(--color-background,#fff);cursor:pointer}
  #shop-by-concern-adv-{{ sid }} .shop-by-concern-adv__tab.is-active{background:var(--color-foreground,#111);color:var(--color-background,#fff);border-color:var(--color-foreground,#111)}
  #shop-by-concern-adv-{{ sid }} .shop-by-concern-adv__grid{display:grid;gap:var(--grid-gap,16px);grid-template-columns:repeat({{ cols_mobile }},minmax(0,1fr))}
  @media(min-width:768px){#shop-by-concern-adv-{{ sid }} .shop-by-concern-adv__grid{grid-template-columns:repeat({{ cols_desktop }},minmax(0,1fr))}}
</style>

{% schema %}
{
  "name": "Shop by Concern Pro",
  "settings": [
    { "type": "text", "id": "heading", "label": "Heading", "default": "Shop by concern" },
    {
      "type": "select",
      "id": "container",
      "label": "Container width",
      "default": "lg",
      "options": [
        { "value": "sm", "label": "Small" },
        { "value": "md", "label": "Medium" },
        { "value": "lg", "label": "Large" },
        { "value": "xl", "label": "Full width" }
      ]
    },
    { "type": "range", "id": "products_per_tab", "min": 2, "max": 50, "step": 1, "label": "Products per tab", "default": 8 },
    { "type": "range", "id": "products_per_row_mobile", "min": 1, "max": 3, "step": 1, "label": "Columns on mobile", "default": 2 },
    { "type": "range", "id": "products_per_row_desktop", "min": 2, "max": 6, "step": 1, "label": "Columns on desktop", "default": 4 },
    { "type": "header", "content": "Collections" },
    { "type": "collection", "id": "collection_1", "label": "Collection 1" },
    { "type": "text", "id": "label_1", "label": "Tab label 1" },
    { "type": "collection", "id": "collection_2", "label": "Collection 2" },
    { "type": "text", "id": "label_2", "label": "Tab label 2" },
    { "type": "collection", "id": "collection_3", "label": "Collection 3" },
    { "type": "text", "id": "label_3", "label": "Tab label 3" },
    { "type": "collection", "id": "collection_4", "label": "Collection 4" },
    { "type": "text", "id": "label_4", "label": "Tab label 4" },
    { "type": "collection", "id": "collection_5", "label": "Collection 5" },
    { "type": "text", "id": "label_5", "label": "Tab label 5" },
    { "type": "collection", "id": "collection_6", "label": "Collection 6" },
    { "type": "text", "id": "label_6", "label": "Tab label 6" }
  ],
  "presets": [
    { "name": "Shop by Concern Pro", "category": "Collection" }
  ]
}
{% endschema %}


