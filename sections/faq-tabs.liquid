{% assign section_settings = section.settings %}
{%- assign tab_blocks = section.blocks | where: 'type', 'tab_title' -%}
{%- assign faq_blocks = section.blocks | where: 'type', 'faq-accordion-row' -%}

<div class="faq-tabs color-{{ section_settings.color_scheme }}" style="{% render 'spacing-style', settings: section_settings %}">
  {% if section_settings.heading != blank %}
    <h2 class="faq-tabs__title">{{ section_settings.heading }}</h2>
  {% endif %}

  {% if tab_blocks.size > 0 %}
    <div class="faq-tabs__nav" role="tablist">
      {% for tab in tab_blocks %}
        {% assign tab_label = tab.settings.label %}
        {% if tab_label == blank %}
          {% assign tab_label = 'Tab ' | append: forloop.index %}
        {% endif %}
        {% assign tab_label_handle = tab_label | handleize %}
        {% assign tab_handle = tab_label_handle | append: '-' | append: tab.id %}
        <button
          class="faq-tabs__nav-btn{% if forloop.first %} is-active{% endif %}"
          role="tab"
          aria-controls="tab-{{ tab_handle }}"
          data-tab="{{ tab_handle }}"
        >
          {{ tab_label }}
        </button>
      {% endfor %}
    </div>

    {% for tab in tab_blocks %}
      {% assign tab_label = tab.settings.label %}
      {% if tab_label == blank %}
        {% assign tab_label = 'Tab ' | append: forloop.index %}
      {% endif %}
      {% assign tab_label_handle = tab_label | handleize %}
      {% assign tab_handle = tab_label_handle | append: '-' | append: tab.id %}
      {% assign has_rows = false %}
      <div id="tab-{{ tab_handle }}" class="faq-tabs__panel{% if forloop.first %} is-active{% endif %}" role="tabpanel">
        <div class="accordion accordion--faq-tabs accordion--plus accordion--dividers">
          {% for faq in faq_blocks %}
            {% assign row_handle = faq.settings.tab_label | handleize %}
            {% if row_handle == tab_label_handle or (faq.settings.tab_label == blank and forloop.parentloop.first) %}
              {% render faq %}
              {% assign has_rows = true %}
            {% endif %}
          {% endfor %}
          {% unless has_rows %}
            <p class="faq-tabs__empty">No FAQs assigned to this tab yet.</p>
          {% endunless %}
        </div>
      </div>
    {% endfor %}
  {% elsif faq_blocks.size > 0 %}
    <div class="accordion accordion--faq-tabs accordion--plus accordion--dividers">
      {% for faq in faq_blocks %}
        {% render faq %}
      {% endfor %}
    </div>
  {% endif %}
</div>

{% javascript %}
  if (!customElements.get('faq-tabs-init')) {
    class FaqTabsInit extends HTMLElement {
      connectedCallback(){
        const root = this.closest('.faq-tabs') || this.parentElement;
        if(!root) return;
        const buttons = root.querySelectorAll('.faq-tabs__nav-btn');
        const panels = root.querySelectorAll('.faq-tabs__panel');
        const setActive = (handle) => {
          buttons.forEach(b => b.classList.toggle('is-active', b.dataset.tab === handle));
          panels.forEach(p => p.classList.toggle('is-active', p.id === `tab-${handle}`));
        };
        buttons.forEach(btn => {
          btn.addEventListener('click', () => setActive(btn.dataset.tab));
        });
      }
    }
    customElements.define('faq-tabs-init', FaqTabsInit);
  }
{% endjavascript %}

<faq-tabs-init></faq-tabs-init>

{% stylesheet %}
  .faq-tabs {
    display: block;
  }
  .faq-tabs__title { margin: 0 0 var(--spacing-4); text-align: center; }
  .faq-tabs__nav {
    display: flex;
    gap: var(--spacing-3);
    justify-content: center;
    margin-bottom: var(--spacing-6);
    flex-wrap: wrap;
  }
  .faq-tabs__nav-btn {
    appearance: none;
    border: 1px solid var(--color-border);
    background: var(--color-background);
    color: var(--color-foreground);
    padding: 10px 16px;
    border-radius: 9999px;
    cursor: pointer;
    font-weight: 600;
  }
  .faq-tabs__nav-btn.is-active {
    background: var(--color-button);
    color: var(--color-button-text);
    border-color: var(--color-button);
  }
  .faq-tabs__panel { display: none; }
  .faq-tabs__panel.is-active { display: block; }
  
  .faq-tabs__empty {
    margin: var(--spacing-4) 0;
    text-align: center;
    color: var(--color-foreground);
    opacity: 0.7;
  }
  
  .accordion--faq-tabs .faq-accordion-row:not(:first-child) .details {
    border-top: 1px solid var(--color-border);
  }
  
  .accordion--faq-tabs .details__header {
    padding: var(--padding-sm) 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
    cursor: pointer;
  }
  
  .accordion--faq-tabs .details[open] .icon-plus {
    transform: rotate(45deg);
    transition: transform 0.2s ease;
  }
  
  .accordion--faq-tabs .icon-plus {
    transition: transform 0.2s ease;
  }
  
  .accordion--faq-tabs .details-content {
    padding-bottom: var(--padding-sm);
  }
{% endstylesheet %}

{% schema %}
{
  "name": "FAQ Tabs",
  "class": "section-faq-tabs",
  "settings": [
    { "type": "text", "id": "heading", "label": "Heading", "default": "FAQ" },
    { "type": "color_scheme", "id": "color_scheme", "label": "t:settings.color_scheme", "default": "scheme-1" },
    { "type": "range", "id": "padding-block-start", "label": "t:settings.top", "min": 0, "max": 100, "step": 1, "unit": "px", "default": 32 },
    { "type": "range", "id": "padding-block-end", "label": "t:settings.bottom", "min": 0, "max": 100, "step": 1, "unit": "px", "default": 32 }
  ],
  "blocks": [
    {
      "type": "tab_title",
      "name": "Tab",
      "settings": [
        { "type": "text", "id": "label", "label": "Label", "default": "General" }
      ]
    },
    { "type": "faq-accordion-row", "name": "FAQ Item" }
  ],
  "presets": [
    {
      "name": "FAQ Tabs",
      "category": "t:categories.storytelling",
      "blocks": {
        "tab-1": {
          "type": "tab_title",
          "settings": { "label": "Our Products" }
        },
        "tab-2": {
          "type": "tab_title",
          "settings": { "label": "Our Company" }
        },
        "tab-3": {
          "type": "tab_title",
          "settings": { "label": "Shipping & Returns" }
        },
        "row-1": {
          "type": "faq-accordion-row",
          "settings": { "tab_label": "Shipping & Returns" }
        },
        "row-2": {
          "type": "faq-accordion-row",
          "settings": { "tab_label": "Shipping & Returns" }
        },
        "row-3": {
          "type": "faq-accordion-row",
          "settings": { "tab_label": "Our Products" }
        }
      },
      "block_order": ["tab-1", "tab-2", "tab-3", "row-1", "row-2", "row-3"]
    }
  ]
}
{% endschema %}


