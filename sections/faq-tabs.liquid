{% assign section_settings = section.settings %}

{% capture tabs %}
  {% for block in section.blocks %}
    {% if block.type == '_faq-tab-title' %}
      {"id":"{{ block.id }}","label":"{{ block.settings.label | escape }}","handle":"{{ block.settings.label | handleize }}"}{% unless forloop.last %},{% endunless %}
    {% endif %}
  {% endfor %}
{% endcapture %}

<div class="faq-tabs color-{{ section_settings.color_scheme }}" style="{% render 'spacing-style', settings: section_settings %}">
  {% if section_settings.heading != blank %}
    <h2 class="faq-tabs__title">{{ section_settings.heading }}</h2>
  {% endif %}

  <div class="faq-tabs__nav" role="tablist">
    {% assign tabs_array = tabs | split: '},{' %}
    {% for t in tabs_array %}
      {% assign raw = t | replace: '[', '' | replace: ']', '' | replace: '{', '' | replace: '}', '' %}
      {% assign label_pair = raw | split: '"label":"' | last %}
      {% assign label = label_pair | split: '"' | first %}
      {% assign handle_pair = raw | split: '"handle":"' | last %}
      {% assign handle = handle_pair | split: '"' | first %}

      <button class="faq-tabs__nav-btn{% if forloop.first %} is-active{% endif %}" role="tab" aria-controls="tab-{{ handle }}" data-tab="{{ handle }}">{{ label }}</button>
    {% endfor %}
  </div>

  {% for t in tabs_array %}
    {% assign raw = t | replace: '[', '' | replace: ']', '' | replace: '{', '' | replace: '}', '' %}
    {% assign label_pair = raw | split: '"label":"' | last %}
    {% assign label = label_pair | split: '"' | first %}
    {% assign handle_pair = raw | split: '"handle":"' | last %}
    {% assign handle = handle_pair | split: '"' | first %}

    <div id="tab-{{ handle }}" class="faq-tabs__panel{% if forloop.first %} is-active{% endif %}" role="tabpanel">
      <div class="accordion accordion--faq-tabs accordion--plus accordion--dividers">
        {% for block in section.blocks %}
          {% if block.type == '_faq-accordion-row' and block.settings.tab_label != blank and block.settings.tab_label | handleize == handle %}
            <div class="faq-accordion-row">
              {% render block %}
            </div>
          {% endif %}
        {% endfor %}
      </div>
    </div>
  {% endfor %}
</div>

{% javascript %}
  if (!customElements.get('faq-tabs-init')) {
    class FaqTabsInit extends HTMLElement {
      connectedCallback(){
        const root = this.closest('.faq-tabs') || this.parentElement;
        if(!root) return;
        const buttons = root.querySelectorAll('.faq-tabs__nav-btn');
        const panels = root.querySelectorAll('.faq-tabs__panel');
        const setActive = (handle) => {
          buttons.forEach(b => b.classList.toggle('is-active', b.dataset.tab === handle));
          panels.forEach(p => p.classList.toggle('is-active', p.id === `tab-${handle}`));
        };
        buttons.forEach(btn => {
          btn.addEventListener('click', () => setActive(btn.dataset.tab));
        });
      }
    }
    customElements.define('faq-tabs-init', FaqTabsInit);
  }
{% endjavascript %}

<faq-tabs-init></faq-tabs-init>

{% stylesheet %}
  .faq-tabs {
    display: block;
  }
  .faq-tabs__title { margin: 0 0 var(--spacing-4); text-align: center; }
  .faq-tabs__nav {
    display: flex;
    gap: var(--spacing-3);
    justify-content: center;
    margin-bottom: var(--spacing-6);
    flex-wrap: wrap;
  }
  .faq-tabs__nav-btn {
    appearance: none;
    border: 1px solid var(--color-border);
    background: var(--color-background);
    color: var(--color-foreground);
    padding: 10px 16px;
    border-radius: 9999px;
    cursor: pointer;
    font-weight: 600;
  }
  .faq-tabs__nav-btn.is-active {
    background: var(--color-button);
    color: var(--color-button-text);
    border-color: var(--color-button);
  }
  .faq-tabs__panel { display: none; }
  .faq-tabs__panel.is-active { display: block; }
  
  .accordion--faq-tabs .faq-accordion-row:not(:first-child) .details {
    border-top: 1px solid var(--color-border);
  }
  
  .accordion--faq-tabs .details__header {
    padding: var(--padding-sm) 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
    cursor: pointer;
  }
  
  .accordion--faq-tabs .details[open] .icon-plus {
    transform: rotate(45deg);
    transition: transform 0.2s ease;
  }
  
  .accordion--faq-tabs .icon-plus {
    transition: transform 0.2s ease;
  }
  
  .accordion--faq-tabs .details-content {
    padding-bottom: var(--padding-sm);
  }
{% endstylesheet %}

{% schema %}
{
  "name": "FAQ Tabs",
  "class": "section-faq-tabs",
  "settings": [
    { "type": "text", "id": "heading", "label": "Heading", "default": "FAQ" },
    { "type": "color_scheme", "id": "color_scheme", "label": "t:settings.color_scheme", "default": "scheme-1" },
    { "type": "range", "id": "padding-block-start", "label": "t:settings.top", "min": 0, "max": 100, "step": 1, "unit": "px", "default": 32 },
    { "type": "range", "id": "padding-block-end", "label": "t:settings.bottom", "min": 0, "max": 100, "step": 1, "unit": "px", "default": 32 }
  ],
  "blocks": [
    { "type": "_faq-tab-title", "name": "Tab" },
    { "type": "_faq-accordion-row", "name": "FAQ Item" }
  ],
  "presets": [
    {
      "name": "FAQ Tabs",
      "category": "t:categories.storytelling",
      "blocks": {
        "tab-1": { "type": "_faq-tab-title" },
        "tab-2": { "type": "_faq-tab-title" },
        "tab-3": { "type": "_faq-tab-title" },
        "row-1": { "type": "_faq-accordion-row" },
        "row-2": { "type": "_faq-accordion-row" },
        "row-3": { "type": "_faq-accordion-row" }
      },
      "block_order": ["tab-1", "tab-2", "tab-3", "row-1", "row-2", "row-3"]
    }
  ]
}
{% endschema %}


